#listens on 80 for http and redirects to https 443
server {
	listen 80 ;
        server_name betamasaheft.eu;
#        server_name betamasaheft.aai.uni-hamburg.de;
#        server_name betamasaheft2.aai.uni-hamburg.de;
        return 301 https://betamasaheft.eu$request_uri;
}

server {
	listen 134.100.28.183:8080 ssl;
        server_name betamasaheft.eu;

        ssl on;
        ssl_certificate /etc/nginx/ssl/cert_bundle2021_3.pem;
        ssl_password_file /etc/nginx/ssl/pass;
        ssl_certificate_key /etc/nginx/ssl/server-key2021_2.pem;

	location / {
		proxy_set_header "X-Forwarded-For" "";
		proxy_set_header "Host" "betamasaheft.eu:8080";
		proxy_pass https://localhost:8443;
		proxy_cookie_domain localhost betamasaheft.eu;
		# proxy_cookie_flags is not available in nginx v1.14.0
                #proxy_cookie_flags secure httponly;
                proxy_cookie_path /exist "/exist; secure; httponly";
	}
}


server {
#listens on 443 for https and does all it needs to do

#	server_name betamasaheft.eu;
    	merge_slashes off;
#        rewrite ^/iiif/(.*) /iipsrv/iipsrv.fcgi?IIIF=/media/HLZ3/Ethio-Spare3/TIFF/%2F$1 last;
         rewrite ^/iiif/(.*) /iipsrv/iipsrv.fcgi?IIIF=/media/aai-hlz-bm/TIFF/%2F$1 last;

# iiif rewrite rule and parameters (needs anyway that they are before spawning the iipImage server)
location /iipsrv/iipsrv.fcgi {
        fastcgi_pass    127.0.0.1:9000;
        fastcgi_param   PATH_INFO $fastcgi_script_name;
        fastcgi_param   REQUEST_METHOD $request_method;
        fastcgi_param   QUERY_STRING $query_string;
        fastcgi_param   CONTENT_TYPE $content_type;
        fastcgi_param   CONTENT_LENGTH $content_length;
        fastcgi_param   SERVER_PROTOCOL $server_protocol;
        fastcgi_param   REQUEST_URI $request_uri;
        fastcgi_param   HTTPS $https if_not_empty;
        fastcgi_param   WATERMARK "/media/add/images/watermarkbw.tif";
        fastcgi_param   WATERMARK_PROBABILITY 0.2;
        fastcgi_param   WATERMARK_OPACITY 0.2;
       add_header Access-Control-Allow-Origin *;
}

	# SSL configuration
	#
	listen 443 ssl ;
        server_name betamasaheft.eu;

	ssl on;
	ssl_certificate /etc/nginx/ssl/cert_bundle2021_3.pem;
	ssl_password_file /etc/nginx/ssl/pass;
        ssl_certificate_key /etc/nginx/ssl/server-key2021_2.pem;

	ssl_session_cache   shared:SSL:20m;
        ssl_session_timeout 180m;

        ssl_protocols       TLSv1.2;
        ssl_ciphers         HIGH:!aNULL:!MD5;


	charset utf-8;
#        proxy_cache_bypass $http_cachepurge;


	root /var/www/html;

	index index.html index.htm index.nginx-debian.html;

error_page 502 /error502.html;
location = /error502.html {
  root   /var/www/html;
  allow all;
}

error_page 403 /error403.html;
location = /error403.html {
  root   /var/www/html;
  allow all;
}

location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        deny all;
    }

location / {
	#blocks blank user_agents
        if ($http_user_agent = "") { return  444 $scheme://www.google.com/; }
        if ($limit_bots = 1) { return  444 $scheme://www.google.com/;}
        if ($bad_ips = 1) { return  444 $scheme://www.google.com/;}
           access_log /var/log/nginx/access.log;
	    proxy_pass http://localhost:8080/exist/apps/BetMasWeb/;
        }

location /fuseki/ {
# allows localhost, techlead machine and nothing else
#            allow 134.100.250.99;
#            allow 127.0.0.1;
#            deny  all;
        #blocks blank user_agents
        if ($http_user_agent = "") { return  444 $scheme://www.google.com/; }
        if ($limit_bots = 1) { return  444 $scheme://www.google.com/;}
           access_log /var/log/nginx/access.log;
            proxy_pass http://localhost:3030/;
            proxy_cache my_cache;
        }

location /collatex/ {
# allows localhost, techlead machine and nothing else
#            allow 134.100.250.99;
#            allow 127.0.0.1;
#            deny  all;
        #blocks blank user_agents
        if ($http_user_agent = "") { return  444 $scheme://www.google.com/; }
        if ($limit_bots = 1) { return  444 $scheme://www.google.com/;}
           access_log /var/log/nginx/access.log;
            proxy_pass http://localhost:8081/collatex-servlet-1.7.1/;
            proxy_cache my_cache;
        }

location /rest/ {
	#blocks blank user_agents
        if ($http_user_agent = "") { return  444 $scheme://www.google.com/; }
        if ($limit_bots = 1) { return  444 $scheme://www.google.com/;}
           access_log /var/log/nginx/access.log;
            proxy_pass http://localhost:8080/exist/rest/apps/;
            proxy_cache my_cache;
        }

location /rdf/ {
	#blocks blank user_agents
        if ($http_user_agent = "") { return  444 $scheme://www.google.com/; }
        if ($limit_bots = 1) { return  444 $scheme://www.google.com/;}
           access_log /var/log/nginx/access.log;
            proxy_pass http://localhost:8080/exist/rest/rdf/;
            proxy_cache my_cache;
        }
location /Dillmann/ {
	#blocks blank user_agents
        if ($http_user_agent = "") { return  444 $scheme://www.google.com/; }
        if ($limit_bots = 1) { return  444 $scheme://www.google.com/;}
           access_log /var/log/nginx/access.log;
           proxy_pass http://localhost:8080/exist/apps/gez-en/;
       }

        if ($limit_bots) {
        return 444;
        }

        if ($bad_ips) {
        return 444;
        }

location /openapi/ {
	#blocks blank user_agents
        if ($http_user_agent = "") { return  444 $scheme://www.google.com/; }
        if ($limit_bots = 1) { return  444 $scheme://www.google.com/;}
           access_log /var/log/nginx/access.log;
           proxy_pass http://localhost:8080/exist/apps/openapi/;
       }


location /AethiopicaCatalogue/ {
        #blocks blank user_agents
        if ($http_user_agent = "") { return  444 $scheme://www.google.com/; }
        if ($limit_bots = 1) { return  444 $scheme://www.google.com/;}
           access_log /var/log/nginx/access.log;
           proxy_pass http://localhost:8080/exist/apps/AethiopicaCatalogue/modules/upload.xql;
       }
location /Guidelines/ {
       #blocks blank user_agents
        if ($http_user_agent = "") { return  444 $scheme://www.google.com/; }
        if ($limit_bots = 1) { return  444 $scheme://www.google.com/;}
           access_log /var/log/nginx/access.log;
           proxy_pass http://localhost:8080/exist/apps/guidelines/;
	}

location /alpheiosannotations/ {
       #blocks blank user_agents
        if ($http_user_agent = "") { return  444 $scheme://www.google.com/; }
        if ($limit_bots = 1) { return  444 $scheme://www.google.com/;}
           access_log /var/log/nginx/access.log;
           proxy_pass http://localhost:8080/exist/apps/alpheiosannotations/;
        }

location ~ \.php$ {
	access_log /var/log/nginx/access.log;
  	deny all;
	}

location ~ \robots.txt {
        access_log /var/log/nginx/access.log;
        deny all;
        }


}
